---
title: 常见TLS安全名词

# []: (new Date()).toJSON()
date: '2021-10-30T10:31:24.683Z'
---

> 本文更多意义在于整理自学知识。现代加密可以说是建立在各个领域的最顶尖成果的基础上，初学入门难免有理解错误之处，欢迎指正。

> 下文以经典的 A(lice)、B(ob)、E(ve)模型来辅助说明。

TLS 最终的核心目标其实不复杂，就是帮助 A、B 在不安全的信道上建立一个安全的会话。安全会话建立的最直接的方法就是在信息发出之前，都用同一个安全的算法、同一份安全的密钥进行加密；但怎么让 A、B 都用同一份密钥？

# 1. KeyAgreement 密钥协商

## 1.1. 密钥分发

A、B 需要一份密钥来开启通信，但交换密钥又需要一次通信，似乎陷入死循环了。这时候，该介绍另一位朋友了，非对称加密。

### 1.1.1. 非对称加密

非对称加密是相对于对称加密的概念。人类的加密手段是从对称加密开始的，这类加密手段的特征是加密和解密的“运算”是对称的。以最简单的查表加密为例，加密时将明文根据密码表映射关系一一替换，待解密人员接收到替换后的密文，也根据密码表将密文替换会原文。也因为运算是对称的，对称加密的另一个特征：加密和解密用的密钥必然是相同的，否则无法保证对称操作对内容无损。

非对称加密则不一样，非对称加密里，加密的运算和解密的运算是不一致的，也因此非对称加密里，加密和解密的密钥一般也是不一致的。现代非堆成加密一般建立在一些公认的数学难题上，这些数学难题在拥有一些特征：正向运算简单，逆向求解困难。我们会把正向运算的输入用作私钥（或私钥的派生基础），意为私有密钥，需要保证其“私有”性质；然后把正向运算的结果用作公钥（或公钥的派生基础），意为公开密钥，可公之于众。这个数学难题的逆向计算难度也就决定了这个非对称加密的强度。

现在常见的非堆成加密本质上都是依赖离散对数求解难题。

> 这也是为什么量子计算机被提出、实现原型之后，现存的非对称加密几乎都被定义为量子不安全：一个新的量子算法能相对快速求解该难题。当然了，这个快速也只是相对，同时不同的非对称对该算法的敏感度也不完全一致，虽然最后肯定能求解但成本攀升速度不一致，这也是目前仍有对现存非对称加密手段进行研究、完善的原因之一。

### 1.1.2. 利用非对称加密分发密钥

A、B 可以先在网络上公开自己的公钥，用公钥加密的信息，只能被对应的私钥解密。如果 A 要找 B，那么 A 就把一个安全的密钥（足够随机足够长），用 B 的公钥加密后发给 B，这样 AB 之间就拥有了“同一份安全的密钥”。

> 为什么 A、B 不直接用非对称算法、密钥对进行通信？

> 因为同有效位<sup>[1]</sup>情况下，非对称加密的速度远比对称加密慢<sup>[2]</sup>。其实也很好理解，因为非对称密钥系统都是在特定数学问题、大基数运算的基础建立的，而对称加密目前流行的设计方法全是位交换、位运算，两者的运算量在原理上就天差地别。

## 1.2. 密钥交换

在利用非对称加密分发密钥的这个体系里，会话密钥是否保密很大程度上取决于私钥是否保密，一旦私钥对 E 不保密，协商过程就如同明文通信了。这种依赖另一种秘密信道来传递密钥的手段其实称之为“密钥分发”(key distribution)更贴切，它的特点是分发的安全性取决于分发信道的安全性。而互联网中公私钥的签发权力集中于权力机构或少数企业手中，这显然与互联网的开放不太吻合。

密钥交换(key exchange)就是另一种更开放的选择。它的目标于密钥分发一致，致力于在不安全的网络中取得共识，完成秘密共享。与密钥分发最大的区别在于：密钥协商里密钥不会通过网络传递。

既然不能直接传递密钥，要怎么达成共识？最常见办法就是传递密钥的“特征”。用一个通俗的例子解释：颜料混合。颜料的混合是一个逆向（从混合好的颜料里分离出原料）困难操作，且是一个符合交换律的操作（即混合顺序不影响最终结果）。

> 从这里开始，下方所有的解释都是简化后的说明。它们不违反基本原理、能有效帮助你理解基础，但实际使用中每个步骤都有可能被附加数不清的取值、运算规则以达到标称安全水平，而这些规则的复杂性也正是大部分密码学应用中缺陷、漏洞出现的源头。<br />
> 因此所有的实践经验中都不鼓励开发者在密码学应用上造轮子、做发明。

### 1.2.1. 颜料混合

通过先协商一种基础颜色（公开），A 和 B 相互传递自己的秘密颜色与公共颜色的混合样本，当 A 和 B 收到对方送来的样本，再把自己的秘密颜色加进去，这样 AB 最终都能得到同一种颜色，但却不需要把秘密颜色放在网络上传递。假设 E 把 A 和 B 的混合样本都各自偷掉一点，再混合起来，他也只能拿到 `2(普通颜色):1(A的秘密颜色):1(B的秘密颜色)` 的混合颜色，并不能拿到 A 和 B 以正确比例混合得到的颜色。

### 1.2.2. Diffie–Hellman key exchange(DH)

刚刚以颜料举例的方法，其实也就是 Diffie–Hellman key exchange(简称 D-H 或 DH) 原理的一种通俗解释。

DH 密钥交换协议最早在 1976 的一篇论文<sup>[3]</sup>中命名、正式提出，它的安全性由一个简单的数学问题来保证: 求解 _y=a<sup>x</sup>_ 容易，但求解 _y=log<sub>a</sub>x_<sup>[4]</sup> 困难。 对于特定的 _a_ 值，比如 _a=2_、_a=10_，我们已经找到了一些技巧来快速得到结果，但对于任意 _a_ 值，目前尚未找到有效的通用解法来求解，这个问题也被称为 discrete logarithm problem(离散对数问题)。

DH 就是利用这个数学难题，对随机的、公开协商的 <span style="color: blue">g</span> 计算 _<span style="color: blue">b</span> = <span style="color: blue">g<sup style="color: red">a</sup></span>_ 并传递 <span style="color: blue">b</span>。假设有人监听了这个通信，为了要得到 _<span style="color: red">a</span>_ 值它就必须要求解 _log<span style="color: blue"><sub>g</sub>b</span>_ 这个刚刚介绍的求解困难问题；变相地，我们保护了 _<span style="color: red">a</span>_ 值。

1. 通信的双发先交换两个公共参数<span style="color: blue">p</span>、<span style="color: blue">g</span>
2. A 取一个秘密值 _<span style="color: red">a</span>_，计算 _x<sub>a</sub> = <span style="color: blue">g</span><sup style="color: red">a</sup> mod <span style="color: blue">p</span>_
3. B 也取一个秘密值 <span style="color: red">b</span>，以类似的过程算出 _x<sub>b</sub>_
4. 双方交换各自的 _x_ 值
5. 以 A 为例，A 接受到 _x<sub>b</sub>_ 后，计算 _<span style="color: red">s</span> = x<sub>b</sub><sup style="color: red">a</sup> mod <span style="color: blue">p</span>_
6. 类似的，B 得到 _x<sub>a</sub>_ 后运用同样的公式就能得到同样的 _<span style="color: red">s</span>_ 值
7. A 和 B 协商共享了密钥 _<span style="color: red">s</span>_

### 1.2.3. Elliptic-curve(EC)

由于 EC 的单向性与可交换性都涉及到并非短文或者拟物可以解释代数知识，这里我们只简单给出结论和简单公式：

1. Elliptic-curve(椭圆曲线)上的点与另一个常数的乘运算具有单向性，即 设点 _P_ 是曲线 **E** 上一点，取 _a_， 求取 _Q = aP_ 简单，求取 _a = P/Q_ 困难

   1.1. 注意这里的乘/除仅作示意，其中乘法并非常见的自然数乘法，求解 _a_ 的过程一般也并非除法

2. 同时上诉乘法运算符合交换律，即 _Q<sub>1</sub> P<sub>2</sub> === P<sub>1</sub> a P<sub>2</sub> === P<sub>1</sub> P<sub>2</sub> a === P<sub>1</sub> Q<sub>2</sub>_。

> 注意，这里的 Elliptic-curve(椭圆曲线)并非我们初等数学里接触的 椭圆标准方程<sup>[5]</sup> ，也非该方程的简单推广（虽然这两个方程确实颇有渊源）。以 spec-256k1 曲线为例，它的外观更类似于 `∝` 符号<sup>[6]</sup>，而不是一个闭合曲线。

> 对椭圆曲线的细节有兴趣的，我推荐阅读知乎上的一篇中文学习分享<sup>[6]</sup>以及 AsiaCrypt 2015 会议上一篇关于 ECC 的研究成果分享<sup>[8]</sup>。前者对曲线的细节已经曲线在加密系统中被如何应用做了较为详细的介绍，后者对 ECDLP(Elliptic-curve discrete logarithm problem，离散对数问题，即上边提到的单向性的数学问题)做了简明扼要的讲解定义，并对当前对该问题在各种求解方法下的复杂度做了介绍分析。

### 1.2.4 Elliptic-curve cryptography(ECC)

ECC 就是 EC 在 cryptography(密码学)的应用的统称，下边将要提到的 ECDH 就是 ECC 的一种。除此之外还有用于签名的 ECDSA、用于非对称加密的 ECIES 等。

#### 1.2.4.1 ECC 与 RSA 的应用差别

##### 1.2.4.1.1 优势 💪

1. 在同等安全度上，ECC 能提供比 RSA 更小的密钥长度；且随着安全度提高，这个优势还在不断扩大
2. 由于计算机的寄存器都是固定大小的，更小的密钥体积代表着更少的指令消费，运算速度也就更快
3. 量子时代下对离散对数问题的求解成本并不是线性的，而是近似指数性的增长。ECC 密钥长度凭借线性增长在可预测时间内还能续命，但 RSA 密钥则是标准的指数增长，续命时间显著短于 ECC，续命成本也越来越高。
4. ECC 的中椭圆曲线取值改变，能带来一定的破解阻拦；极端情况下，可能出现 P-224 曲线被破解，但 P-256 曲线依然安全的可能。这也是国密算法中的非对称算法 SM2 能基于 ECC 的原因之一，就算 NIST 在现行的 ECC 推荐曲线中加料了，也大概率不影响经过内部审计的 SM2 推荐曲线。

##### 1.2.4.1.2 劣势 💀

1. ECC 在流行度上不如 RSA。这是出生年纪决定的问题，一些为了稳定、安全而长年断网、不更新或无法更新的设备，可能只接受 RSA 算法，如 芯片卡、隔离系统 等。
2. ECC 的研究时间不如 RSA 时间长，有些问题可能需要时间来消化、研究、暴露；如最近暴露出的 ECDSA 随机数问题，在之前业界普遍认为，有缺陷的(如能被预测等)随机数生成器是会影响 ECDSA 可靠度但尚在可接受范围内（破解时间仍长得没有实际意义）；可最近的研究表明在适当条件下，随机数生成器的缺陷能导致私钥在可接受成本内被从签名结果中逐步提取出来<sup>[9]</sup>。

### 1.2.5. Elliptic-curve Diffie–Hellman(ECDH)

ECDH 就是 Diffie–Hellman key exchange 基于 Elliptic-curve 的一个变种实现，原理类似但依赖的数学问题不一样了，所以整个密钥交换过程也是类似的。

在 ECDH 里，A、B 通过公开信道，商议确定同一条曲线(公式的参数)及同一个 _a_ 值，分别选取各自的秘密 _P<sub>a</sub>_ 与 _P<sub>b</sub>_ ，交换秘密值 _P_ 与 _a_ 相乘结果 _Q_ ，再把各自秘密与对方传来的 _Q_ 值相乘，就能得到同一个、共享的秘密了。而根据单向性，E 就算监听得到 _Q<sub>a</sub>_ 与 _Q<sub>b</sub>_ ，也无法分离双方的输入、计算最后的共享秘密。

# 2. Authentication 认证

## 2.1. 为何要认证

我们以上解决了交换的问题，但互联网之上，彼此第一次见面，A 如何知道跟自己通信的就是 B？通常，我们使用一个叫签名的技术来完成这一步。

## 2.2. 签名

如同我们线下签约，彼此通过签名、指纹甚至公章来确认自己身份。一旦有了纠纷，拿着这些证据到第三方申请验证（笔迹对比、指纹对比、公章验证），第三方便可根据这些信息告诉你，这些信息是否来自正主。

网络也一个道理，但是这个过程更加实时。当你不知道对方是不是 B 时，你可以要求 B 用它的私钥，对一段你指定的信息进行签名，如果签名能被公钥认证，那么对方就是公钥认证了的 B。

### 2.2.1. RSA

RSA 作为一个公私钥系统，理所当然能用来做签名、验签。

### 2.2.2 DSS(DSA)

一个由美国政府制定的签名系统，它包含了密钥生成、签名、验签三部分。DSS 的安全性基于离散对数难题，DSS 的密钥生成过程就是生成一组满足指定离散对数关系的素数的过程。

而 DSA 则特指 DSS 中描述的用于签名、验签过程的算法，DSA 的特点是只要是基于离散对数难题的公私钥系统都可以利用这个算法来进行签名、验签。

显然，以上 DSS 生成的密钥就能符合 DSA 的使用条件。

### 2.2.3 ECDSA

ECDSA 是 DSA 在 ECC 上的变种。EC 是一个在特殊代数域的离散对数难题，显然也符合 DSA 的符合条件，只是要进行一点点的改造，因为 EC 的运算规则与普通的离散代数运算规则不太一致。

## 2.3. 证书

# 3. Encryption 加密

# 参考资料

- [1] [Key size difference between AES and RSA](https://security.stackexchange.com/a/38026)
- [2] [Speed Comparison of Popular Crypto Algorithms](https://cryptopp.com/benchmarks.html)
- [3] [New Directions in Cryptography (1976)](https://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.37.9720)
- [4] [Discrete logarithm](https://en.wikipedia.org/wiki/Discrete_logarithm)
- [5] [椭圆的标准方程](https://baike.baidu.com/item/椭圆的标准方程)
- [6] [Secp256k1](https://en.bitcoin.it/wiki/Secp256k1)
- [7] [理解椭圆函数加密（初等内容介绍）](https://zhuanlan.zhihu.com/p/42983540)
- [8] [Algorithms for the ECDLP](https://www.math.u-bordeaux.fr/~aenge/ecc2015/documents/galbraith.pdf)
- [9] [VaultHSM：OpenPGP 智能卡中确定性 ECDSA 的测试方法](https://zhuanlan.zhihu.com/p/429119101)
- [一个藏在我们身边的巨型僵尸网络 Pink](https://blog.netlab.360.com/pinkbot)
