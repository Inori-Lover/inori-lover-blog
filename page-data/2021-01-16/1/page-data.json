{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-01-16/1/","result":{"data":{"site":{"siteMetadata":{"title":"乐园遗梦","author":"inori_lover"}},"markdownRemark":{"id":"ec616d95-9776-55b3-8dec-e7c2807636d3","excerpt":"为什么突然揭⚰而起 最近算是逐渐熟悉手头的工作节奏了，跟同事磨合之后原本比较麻烦的事情也慢慢因为习惯、共识得到简化了。加之下午在群里看到某前辈分享了一篇关于“如何在react useState里使用set”的外语文章，怀着满心欢喜点进去后却发现只是对set…","html":"<h3>为什么突然揭⚰而起</h3>\n<p>最近算是逐渐熟悉手头的工作节奏了，跟同事磨合之后原本比较麻烦的事情也慢慢因为习惯、共识得到简化了。加之下午在群里看到某前辈分享了一篇关于“如何在react useState里使用set”的外语文章，怀着满心欢喜点进去后却发现只是对set数据结构做一个简单介绍&#x26;给出了一个如何在useState中使用set结构的方法：每次setState都<code class=\"language-text\">new Set()</code>一次。(掀桌(╯‵□′)╯︵┻━┻</p>\n<p>我也可以氵一篇“如何在react中使用数组”(二次掀桌(╯‵□′)╯︵┻━┻</p>\n<h3>immer</h3>\n<p>immer是一个好文明，它通过monkey patch每种能想到、能patch的操作，让我们使用熟悉的api、语法的同时，把mutable操作全部内部变成immutable操作，每次修改都会返回新对象而且更新范围能维持在最小——甚至如果你没修改，那更新范围是0，返回原对象。</p>\n<h3>如何在useState里结合immer使用？</h3>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>selected<span class=\"token punctuation\">,</span> setSelected<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> clickHandle <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setSelected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">preSelected</span> <span class=\"token operator\">=></span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>preSelected<span class=\"token punctuation\">,</span> <span class=\"token parameter\">selected</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    selected<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>clickHandle<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>test<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>这看起来有点糟糕？跟<code class=\"language-text\">new Set()</code>方案没什么区别，也就少了个new操作。</p>\n<h3>加一点魔法✨</h3>\n<p>这个想法其实来源与<code class=\"language-text\">dva-immer</code>, 各位可以先看看它的<a href=\"https://www.npmjs.com/package/dva-immer\">介绍</a>。基本思路就是通过封装，把原本useState返回的set操作，封装在produce里。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> useImmer <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">any</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token parameter\">initalValue<span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">T</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> useState<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>initalValue<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> setStateThroughImmer <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">producer<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>preState<span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span><span class=\"token operator\">|</span>undefined</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">preValue</span> <span class=\"token operator\">=></span> <span class=\"token function\">produce</span><span class=\"token punctuation\">(</span>preValue<span class=\"token punctuation\">,</span> producer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setStateThroughImmer<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ==============</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>selected<span class=\"token punctuation\">,</span> setSelected<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useImmer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> clickHandle <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setSelected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">preSelected</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    selected<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>button onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>clickHandle<span class=\"token punctuation\">}</span><span class=\"token operator\">></span>test<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>改进</h3>\n<p>immer的produce其实可以接受第三参数，<a href=\"https://immerjs.github.io/immer/docs/patches\">用来记录操作顺序，方便做undo/redo等</a>；同时上边的ts类型也写得比较简单，详细一点的话可以适配更多的操作场景，比如指定了类型但是初始值是undefined的情况，通过覆（抄）写useState的类型可以达到与原setState完全一致的API暴露。</p>\n<p>同时在搜索了一下npm之后，发现早有前辈写类似的东西了，基于immer的<a href=\"https://www.npmjs.com/package/use-immer\">use-immer</a>和基于<a href=\"https://www.npmjs.com/package/immutable\">immutable</a>的<a href=\"https://www.npmjs.com/package/use-immutable\">use-immutable</a>。前者不知道是immer维护者的库，质量有保证；后者民间维护但貌似还附带了Reactivity的特性，直接修改就行，不用set（这好还是不好…不评价）。</p>\n<h3>之后</h3>\n<p>应该会再有一篇关于用immer的patch做变更检测的氵文和一篇对dva做一层factory来达到ts提示的文章，前者还在想法雏形，后者已经在我的个人项目实际用上了，体感愉悦。</p>","frontmatter":{"title":"在react里边使用ES6 Set数据结构","date":"January 16, 2021"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2021-01-16/1/","previous":{"fields":{"slug":"/2019-11-09/1/"},"frontmatter":{"title":"对env的理解"}},"next":null}}}